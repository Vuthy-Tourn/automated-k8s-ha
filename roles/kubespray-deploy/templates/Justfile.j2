# ================================================================
# Justfile â€” reusable cluster commands on master1
# Usage:
#   just setup-cluster    â†’ deploy the K8s cluster
#   just destroy-cluster  â†’ reset/wipe the cluster
#   just status           â†’ show node and pod status
#   just kubeconfig       â†’ (re)copy admin.conf to ~/.kube/config
# ================================================================

inventory := "inventory/sample/inventory.ini"

# Deploy the HA K8s cluster
setup-cluster:
    @echo "ğŸš€ Bringing up the HA K8s cluster..."
    . venv/bin/activate && \
    ansible-playbook -b -v -i {{ "{{" }} inventory {{ "}}" }} cluster.yml

# Reset / destroy the cluster
destroy-cluster:
    @echo "ğŸ—‘ï¸  Resetting the HA K8s cluster..."
    . venv/bin/activate && \
    ansible-playbook -b -v -i {{ "{{" }} inventory {{ "}}" }} reset.yml

# Show node and pod status (run from master1 after setup)
status:
    @echo "ğŸ“‹ Node status:"
    kubectl get nodes -o wide
    @echo ""
    @echo "ğŸ“¦ Pod status:"
    kubectl get pods -A

# (Re)copy admin.conf to ~/.kube/config so kubectl works without sudo
kubeconfig:
    @echo "ğŸ”‘ Copying kubeconfig..."
    mkdir -p $HOME/.kube
    sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    sudo chown $(id -u):$(id -g) $HOME/.kube/config
    @echo "âœ… kubectl is ready. Run: kubectl get nodes"

# Upgrade the cluster to a new Kubernetes version
# Usage: just upgrade kube_version=v1.30.0
upgrade kube_version="v1.29.3":
    @echo "â¬†ï¸  Upgrading cluster to {{ "{{" }} kube_version {{ "}}" }}..."
    . venv/bin/activate && \
    ansible-playbook -b -v -i {{ "{{" }} inventory {{ "}}" }} upgrade-cluster.yml \
      -e kube_version={{ "{{" }} kube_version {{ "}}" }}
