---
# ================================================================
# KUBERNETES DASHBOARD — Using Kubespray Built-in Addon
# Only configure access (RBAC + Ingress + Token)
# ================================================================

# ────────────────────────────────────────────────────────────────
# 1️⃣ Wait until Dashboard is running (installed by Kubespray)
# ────────────────────────────────────────────────────────────────
- name: Wait for Dashboard deployment to exist
  command: >
    kubectl -n {{ dashboard_namespace }}
    get deployment kubernetes-dashboard
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: dashboard_check
  retries: 15
  delay: 20
  until: dashboard_check.rc == 0

- name: Wait for Dashboard pods to be Ready
  command: >
    kubectl -n {{ dashboard_namespace }}
    wait --for=condition=ready pod
    -l k8s-app=kubernetes-dashboard
    --timeout=300s
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

# ────────────────────────────────────────────────────────────────
# 2️⃣ Create Admin ServiceAccount + ClusterRoleBinding
# ────────────────────────────────────────────────────────────────
- name: Create Dashboard admin RBAC manifest
  template:
    src: dashboard-admin.yaml.j2
    dest: /tmp/dashboard-admin.yaml

- name: Apply Dashboard admin RBAC
  command: kubectl apply -f /tmp/dashboard-admin.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

# ────────────────────────────────────────────────────────────────
# 3️⃣ Create Ingress (HTTPS via Cloudflare)
# ────────────────────────────────────────────────────────────────
- name: Create Dashboard Ingress manifest
  template:
    src: dashboard-ingress.yaml.j2
    dest: /tmp/dashboard-ingress.yaml

- name: Apply Dashboard Ingress
  command: kubectl apply -f /tmp/dashboard-ingress.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

# ────────────────────────────────────────────────────────────────
# 4️⃣ Generate long-lived token (1 year)
# ────────────────────────────────────────────────────────────────
- name: "Generate Dashboard admin token (1 year)"
  command: >
    kubectl -n {{ dashboard_namespace }}
    create token admin-user --duration=8760h
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: dashboard_token

- name: "Save Dashboard token to file"
  copy:
    content: "{{ dashboard_token.stdout }}"
    dest: "/home/{{ ssh_user }}/dashboard-token.txt"
    mode: '0600'