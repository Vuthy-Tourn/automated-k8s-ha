---
# ================================================================
# KUBERNETES DASHBOARD â€” install via helm from local controller
# ================================================================

- name: Add kubernetes-dashboard helm repo
  command: helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  delegate_to: localhost
  ignore_errors: yes

- name: Update helm repos
  command: helm repo update
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  delegate_to: localhost

- name: Create dashboard namespace
  command: kubectl create namespace {{ dashboard_namespace }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  delegate_to: localhost
  ignore_errors: yes

- name: Install Kubernetes Dashboard via Helm
  command: >
    helm upgrade --install kubernetes-dashboard
    kubernetes-dashboard/kubernetes-dashboard
    --namespace {{ dashboard_namespace }}
    --set nginx.enabled=false
    --set cert-manager.enabled=false
    --set metricsScraper.enabled=true
    --wait --timeout 300s
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  delegate_to: localhost

- name: Apply Dashboard admin ServiceAccount + ClusterRoleBinding
  template:
    src: dashboard-admin.yaml.j2
    dest: /tmp/dashboard-admin.yaml
  delegate_to: localhost

- name: Deploy Dashboard admin resources
  command: kubectl apply -f /tmp/dashboard-admin.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  delegate_to: localhost

- name: Apply Dashboard Ingress
  template:
    src: dashboard-ingress.yaml.j2
    dest: /tmp/dashboard-ingress.yaml
  delegate_to: localhost

- name: Deploy Dashboard Ingress
  command: kubectl apply -f /tmp/dashboard-ingress.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  delegate_to: localhost

- name: Generate long-lived Dashboard admin token (1 year)
  command: >
    kubectl -n {{ dashboard_namespace }}
    create token admin-user --duration=8760h
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: dashboard_token
  delegate_to: localhost

- name: Save Dashboard token locally
  copy:
    content: "{{ dashboard_token.stdout }}"
    dest: "kubeconfig/dashboard-token.txt"
    mode: '0600'
  delegate_to: localhost

- name: Dashboard summary
  debug:
    msg: |
      âœ… Kubernetes Dashboard deployed!
      ðŸ”— URL   : https://{{ dashboard_subdomain }}.{{ cloudflare_zone }}
      ðŸ”‘ Token : saved â†’ kubeconfig/dashboard-token.txt
