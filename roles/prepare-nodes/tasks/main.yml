---
# ── Wait for apt lock ─────────────────────────────────────────────
- name: Wait for apt lock to be released
  shell: |
    while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1 || \
          fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do
      echo "Waiting for apt lock..."; sleep 5;
    done
  changed_when: false

# ── Packages ──────────────────────────────────────────────────────
- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install required base packages
  apt:
    name:
      - curl
      - wget
      - git
      - vim
      - net-tools
      - python3-pip
      - python3-netaddr
      - python3-setuptools
      - apt-transport-https
      - ca-certificates
      - gnupg
      - lsb-release
      - socat
      - conntrack
      - ipset
      - ipvsadm
      - nfs-common
      - chrony
      - rsync
      - unzip
    state: present

# ── Swap ──────────────────────────────────────────────────────────
- name: Disable swap immediately
  command: swapoff -a
  when: ansible_swaptotal_mb > 0
  changed_when: true

- name: Remove swap from /etc/fstab permanently
  replace:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s+\S+\s+.*)$'
    replace: '# \1'

# ── Kernel modules ────────────────────────────────────────────────
- name: Load required kernel modules now
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - br_netfilter
    - overlay
    - ip_vs
    - ip_vs_rr
    - ip_vs_wrr
    - ip_vs_sh
    - nf_conntrack

- name: Persist kernel modules across reboots
  copy:
    dest: /etc/modules-load.d/k8s.conf
    content: |
      br_netfilter
      overlay
      ip_vs
      ip_vs_rr
      ip_vs_wrr
      ip_vs_sh
      nf_conntrack

# ── Sysctl ────────────────────────────────────────────────────────
- name: Apply sysctl settings for Kubernetes
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    sysctl_set: yes
    state: present
    reload: yes
  loop:
    - { key: 'net.bridge.bridge-nf-call-iptables',  value: '1' }
    - { key: 'net.bridge.bridge-nf-call-ip6tables', value: '1' }
    - { key: 'net.ipv4.ip_forward',                 value: '1' }
    - { key: 'net.ipv4.conf.all.rp_filter',         value: '1' }
    - { key: 'vm.max_map_count',                     value: '262144' }
    - { key: 'fs.inotify.max_user_watches',          value: '524288' }
    - { key: 'fs.inotify.max_user_instances',        value: '512' }
    - { key: 'kernel.pid_max',                       value: '4194304' }

# ── Hostname + /etc/hosts ─────────────────────────────────────────
- name: Set hostname to match inventory name
  hostname:
    name: "{{ inventory_hostname }}"

- name: Add all cluster nodes to /etc/hosts
  lineinfile:
    path: /etc/hosts
    regexp: "^.*{{ item }}$"
    line: "{{ hostvars[item]['ip'] }} {{ item }}"
    state: present
  loop: "{{ groups['all'] }}"

# ── Load node_info ────────────────────────────────────────────────
- name: Load node_info from file
  set_fact:
    node_info: "{{ lookup('file', '../inventory/node_info.json') | from_json }}"
  run_once: true
  delegate_to: localhost
  when: node_info is not defined

# Kubespray hardcodes lb-apiserver.kubernetes.local as the control
# plane FQDN — add it here so all nodes can resolve it without a
# real load balancer or external DNS
- name: Add lb-apiserver.kubernetes.local to /etc/hosts
  lineinfile:
    path: /etc/hosts
    regexp: "lb-apiserver.kubernetes.local"
    line: "{{ (node_info | selectattr('role', 'equalto', 'master') | list | first).internal_ip }} lb-apiserver.kubernetes.local"
    state: present

# ── File descriptor limits ────────────────────────────────────────
- name: Set file descriptor limits
  pam_limits:
    domain: '*'
    limit_type: "{{ item.type }}"
    limit_item: "{{ item.item }}"
    value: "{{ item.value }}"
  loop:
    - { type: 'soft', item: 'nofile',   value: '1048576' }
    - { type: 'hard', item: 'nofile',   value: '1048576' }
    - { type: 'soft', item: 'nproc',    value: 'unlimited' }
    - { type: 'hard', item: 'nproc',    value: 'unlimited' }

# ── Chrony ────────────────────────────────────────────────────────
- name: Start and enable chrony
  systemd:
    name: chrony
    state: started
    enabled: yes

# ── UFW ───────────────────────────────────────────────────────────
# UFW would block Kubespray's iptables rules — disable entirely
- name: Disable UFW
  systemd:
    name: ufw
    state: stopped
    enabled: no
  ignore_errors: yes

- name: Node preparation complete
  debug:
    msg: "✅ Node {{ inventory_hostname }} prepared ({{ ansible_host }})"