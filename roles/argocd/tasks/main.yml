---
# ================================================================
# ARGOCD â€” post-deploy configuration via Kubespray addon
# ================================================================

- name: "Wait for ArgoCD server deployment to be ready"
  command: >
    kubectl rollout status deployment/argocd-server
    -n {{ argocd_namespace }}
    --timeout=300s
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: "Patch ArgoCD to run in insecure mode (Ingress handles TLS)"
  command: >
    kubectl patch configmap argocd-cmd-params-cm
    -n {{ argocd_namespace }}
    --type merge
    -p '{"data": {"server.insecure": "true"}}'
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: "Restart ArgoCD server to apply new config"
  command: kubectl rollout restart deployment/argocd-server -n {{ argocd_namespace }}
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: "Wait for ArgoCD server to be ready after restart"
  command: >
    kubectl rollout status deployment/argocd-server
    -n {{ argocd_namespace }}
    --timeout=300s
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: "Apply ArgoCD Ingress for Cloudflare domain"
  template:
    src: argocd-ingress.yaml.j2
    dest: /tmp/argocd-ingress.yaml

- name: "Deploy ArgoCD Ingress"
  command: kubectl apply -f /tmp/argocd-ingress.yaml
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"

- name: "Get ArgoCD initial admin password"
  command: >
    kubectl -n {{ argocd_namespace }}
    get secret argocd-initial-admin-secret
    -o jsonpath="{.data.password}"
  environment:
    KUBECONFIG: "{{ kubeconfig_path }}"
  register: argocd_password_b64

- name: "Decode ArgoCD admin password"
  command: echo "{{ argocd_password_b64.stdout }}" | base64 -d
  register: argocd_password