---
# ================================================================
#  MAIN PLAYBOOK — Full HA K8s Cluster on GCP
# ================================================================
#
#  PIPELINE:
#   Stage 1 │ local     │ GCP API: VPC + firewall + 5 VMs, write dynamic inventory
#   Stage 2 │ all nodes │ OS prep (swap off, sysctl, packages, /etc/hosts)
#   Stage 3 │ master1   │ Clone kubespray → inventory.ini + addons.yml + Justfile
#            │           │ → ansible-playbook cluster.yml (master1 → all nodes)
#            │           │ → copy admin.conf → ~/.kube/config on master1
#   Stage 4 │ local     │ Cloudflare DNS A records
#
#  RUN:
#   ansible-playbook playbooks/main.yml
#
#  TAGS:
#   --tags provision     GCP VMs only
#   --tags prepare       OS prep only
#   --tags kubespray     Kubespray install only
#   --tags dns           Cloudflare DNS only
#   --skip-tags provision  (VMs already exist)
# ================================================================

# ── STAGE 1: Provision GCP VMs ────────────────────────────────────
- name: "STAGE 1 | Provision GCP VMs and build dynamic inventory"
  hosts: localhost
  connection: local
  gather_facts: yes
  tags: [provision, always]
  vars_files:
    - ../vars/all.yml
  tasks:
    - name: Include GCP provision tasks
      include_tasks: ./tasks/create-gcp.yml

# ── STAGE 2: Prepare all 5 nodes ─────────────────────────────────
- name: "STAGE 2 | Prepare all cluster nodes"
  hosts: all
  gather_facts: yes
  become: yes
  tags: [prepare]
  vars_files:
    - ../vars/all.yml
  roles:
    - role: prepare-nodes

# ── STAGE 3: Kubespray on master1 ────────────────────────────────
- name: "STAGE 3 | Deploy K8s via Kubespray on master1"
  hosts: "{{ cluster_name }}-master-1"
  gather_facts: yes
  become: yes
  tags: [kubespray]
  vars_files:
    - ../vars/all.yml
  roles:
    - role: kubespray-deploy

# ── STAGE 4: Cloudflare DNS ───────────────────────────────────────
- name: "STAGE 4 | Configure Cloudflare DNS records"
  hosts: localhost
  connection: local
  gather_facts: no
  tags: [dns]
  vars_files:
    - ../vars/all.yml
    - ../vars/cloudflare_vars.yml
  pre_tasks:
    - name: Lookup Cloudflare Zone ID
      uri:
        url: "https://api.cloudflare.com/client/v4/zones?name={{ cloudflare_zone }}"
        method: GET
        headers:
          Authorization: "Bearer {{ cloudflare_api_token }}"
        status_code: 200
      register: cf_zone_lookup

    - name: Set Zone ID fact
      set_fact:
        cf_zone_id: "{{ cf_zone_lookup.json.result[0].id }}"
  roles:
    - role: cloudflare-dns
