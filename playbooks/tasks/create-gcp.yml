---
# ================================================================
# CREATE-GCP â€” Provision all GCP infrastructure
# Included by playbooks/main.yml Stage 1
# ================================================================

# â”€â”€ Controller dependencies â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Verify required Python packages on controller
  pip:
    name:
      - requests
      - google-auth
      - google-api-python-client
      - packaging
    state: present
  delegate_to: localhost

- name: Install Ansible GCP collection
  command: ansible-galaxy collection install google.cloud --force
  run_once: true

- name: Ensure SSH key directory exists
  file:
    path: "{{ ssh_private_key | dirname }}"
    state: directory
    mode: "0700"

- name: Generate SSH key pair for cluster nodes
  openssh_keypair:
    path: "{{ ssh_private_key }}"
    type: rsa
    size: 4096
    comment: "k8s-cluster-key"
    force: false
    mode: "0600"

# Always enforce correct permissions regardless of whether key was just created
- name: Enforce SSH key file permissions
  file:
    path: "{{ item.path }}"
    mode: "{{ item.mode }}"
  loop:
    - { path: "{{ ssh_private_key }}",      mode: "0600" }
    - { path: "{{ ssh_public_key }}",       mode: "0644" }

- name: Read SSH public key
  slurp:
    src: "{{ ssh_public_key }}"
  register: _ssh_pub_raw

- name: Set SSH public key fact
  set_fact:
    ssh_pub_key: "{{ _ssh_pub_raw.content | b64decode | trim }}"

# â”€â”€ Firewall Rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Create Kubernetes firewall rules
  google.cloud.gcp_compute_firewall:
    name: "{{ item.name }}"
    network:
      selfLink: "https://www.googleapis.com/compute/v1/projects/{{ gcp_project_id }}/global/networks/default"
    allowed:
      - ip_protocol: "{{ item.protocol }}"
        ports: "{{ item.ports }}"
    target_tags: "{{ item.tags }}"
    source_ranges: "{{ item.source_ranges }}"
    description: "{{ item.description }}"
    project: "{{ gcp_project_id }}"
    auth_kind: application
    state: present
  loop: "{{ k8s_firewall_rules }}"
  loop_control:
    label: "{{ item.name }}"
  environment:
    GOOGLE_APPLICATION_CREDENTIALS: "{{ adc_file }}"
    GOOGLE_EXTERNAL_ACCOUNT_ALLOW_EXECUTABLES: "1"

# â”€â”€ Build flat VM list â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Build flat VM definition list from node_groups
  set_fact:
    all_vm_definitions: "{{ _vms }}"
  vars:
    _vms: >-
      {%- set vms = [] -%}
      {%- for group in node_groups -%}
        {%- for idx in range(group.count | int) -%}
          {%- set _ = vms.append({
            'name':         cluster_name ~ '-' ~ group.role ~ '-' ~ (idx + 1) | string,
            'role':         group.role,
            'zone':         group.zone,
            'region':       group.get('region', 'MISSING-REGION'),
            'subnet_cidr':  group.get('subnet_cidr', 'MISSING-CIDR'),
            'machine_type': group.get('machine_type', gcp_machine_type),
            'disk_size':    group.get('disk_size_gb', gcp_disk_size_gb) | int,
            'disk_type':    group.get('disk_type', gcp_disk_type),
            'tags':         group.get('tags', [cluster_name ~ '-node', cluster_name ~ '-' ~ group.role])
          }) -%}
        {%- endfor -%}
      {%- endfor -%}
      {{ vms }}

- name: Validate and show VM plan
  debug:
    msg: |
      ðŸ“‹ VM plan ({{ all_vm_definitions | length }} total):
      {% for vm in all_vm_definitions %}
        [{{ vm.role | upper }}] {{ vm.name }}  zone={{ vm.zone }}  type={{ vm.machine_type }}  region={{ vm.region }}
      {% endfor %}
  failed_when: >-
    all_vm_definitions | selectattr('region', 'equalto', 'MISSING-REGION') | list | length > 0

# â”€â”€ Create ALL VMs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Create all cluster VMs
  google.cloud.gcp_compute_instance:
    name: "{{ item.name }}"
    machine_type: "{{ item.machine_type }}"
    zone: "{{ item.zone }}"
    disks:
      - auto_delete: true
        boot: true
        initialize_params:
          source_image: "projects/{{ gcp_image_project }}/global/images/family/{{ gcp_image_family }}"
          disk_size_gb: "{{ item.disk_size }}"
          disk_type: "{{ item.disk_type | default(gcp_disk_type) }}"
    network_interfaces:
      - network:
          selfLink: "projects/{{gcp_project_id}}/global/networks/default"
        access_configs:
          - name: External NAT
            type: ONE_TO_ONE_NAT
    metadata:
      ssh-keys: "{{ ssh_user }}:{{ ssh_pub_key }}"
      startup-script: "{{ lookup('template', '../../templates/startup-script.sh.j2') }}"
    tags:
      items: "{{ item.tags }}"
    project: "{{ gcp_project_id }}"
    auth_kind: application
    state: present
  loop: "{{ all_vm_definitions }}"
  loop_control:
    label: "{{ item.name }} ({{ item.zone }})"
  register: vm_results
  retries: 3          # â† retry up to 3 times
  delay: 15           # â† wait 15s between retries
  until: vm_results is not failed
  environment: 
      GOOGLE_APPLICATION_CREDENTIALS: "{{ adc_file }}"
      GOOGLE_EXTERNAL_ACCOUNT_ALLOW_EXECUTABLES: "1"

# â”€â”€ Extract IPs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Wait for VMs to finish startup-script
  pause:
    seconds: 30
    prompt: "Waiting for VMs to finish booting..."

- name: Build unified node_info list
  set_fact:
    node_info: "{{ _nodes }}"
  vars:
    _nodes: >-
      {%- set nodes = [] -%}
      {%- for i in range(vm_results.results | length) -%}
        {%- set res   = vm_results.results[i] -%}
        {%- set defn  = all_vm_definitions[i] -%}
        {%- set iface = res.networkInterfaces[0] -%}
        {%- set _ = nodes.append({
          'name':        res.name,
          'role':        defn.role,
          'zone':        defn.zone,
          'region':      defn.region,
          'external_ip': iface.accessConfigs[0].natIP | default(''),
          'internal_ip': iface.networkIP
        }) -%}
      {%- endfor -%}
      {{ nodes }}

- name: Save node_info to file
  copy:
    content: "{{ node_info | to_nice_json }}"
    dest: "../inventory/node_info.json"

- name: Display provisioned VMs
  debug:
    msg: |
      âœ… GCP VMs ready ({{ node_info | length }} total):
      {% for node in node_info %}
      [{{ node.role | upper }}] {{ node.name }}  ext={{ node.external_ip }}  int={{ node.internal_ip }}
      {% endfor %}

# â”€â”€ Per-role IP facts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Set per-role IP facts
  set_fact:
    "{{ item.role }}_ips":          "{{ node_info | selectattr('role', 'equalto', item.role) | map(attribute='external_ip')  | list }}"
    "{{ item.role }}_internal_ips": "{{ node_info | selectattr('role', 'equalto', item.role) | map(attribute='internal_ip') | list }}"
    "{{ item.role }}_names":        "{{ node_info | selectattr('role', 'equalto', item.role) | map(attribute='name')        | list }}"
  loop: "{{ node_groups }}"
  loop_control:
    label: "{{ item.role }}"

# â”€â”€ Write inventory files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Write dynamic hosts.ini
  template:
    src: "../../templates/dynamic-hosts.ini.j2"
    dest: "../inventory/inventory.ini"

- name: Refresh in-memory Ansible inventory
  meta: refresh_inventory

# â”€â”€ Wait for SSH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: Wait for SSH on all nodes
  wait_for:
    host: "{{ item.external_ip }}"
    port: 22
    timeout: 300
    state: started
    delay: 5
  loop: "{{ node_info }}"
  loop_control:
    label: "{{ item.name }} â†’ {{ item.external_ip }}"