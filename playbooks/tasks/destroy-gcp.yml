---
# ================================================================
# DESTROY-GCP â€” Remove all GCP cluster resources
# Run: ansible-playbook playbooks/tasks/destroy-gcp.yml
#   or via Justfile: just destroy-infra
# ================================================================
- name: "TEARDOWN | Destroy all GCP cluster resources"
  hosts: localhost
  connection: local
  gather_facts: yes
  vars_files:
    - ../../vars/all.yml

  tasks:
    - name: Confirm teardown
      pause:
        prompt: |
          âš ï¸  WARNING: This will DESTROY all GCP VMs and firewall rules
          for cluster '{{ cluster_name }}' in project '{{ gcp_project_id }}'.
          Press ENTER to continue or Ctrl+C to abort.

    # â”€â”€ Build flat VM list (mirrors create-gcp exactly) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Build flat VM definition list from node_groups
      set_fact:
        all_vm_definitions: "{{ _vms }}"
      vars:
        _vms: >-
          {%- set vms = [] -%}
          {%- for group in node_groups -%}
            {%- for idx in range(group.count | int) -%}
              {%- set _ = vms.append({
                'name': cluster_name ~ '-' ~ group.role ~ '-' ~ (idx + 1) | string,
                'zone': group.zone
              }) -%}
            {%- endfor -%}
          {%- endfor -%}
          {{ vms }}

    # â”€â”€ Delete VMs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Delete all cluster VMs
      google.cloud.gcp_compute_instance:
        name: "{{ item.name }}"
        zone: "{{ item.zone }}"
        project: "{{ gcp_project_id }}"
        auth_kind: application
        state: absent
      loop: "{{ all_vm_definitions }}"
      loop_control:
        label: "{{ item.name }} ({{ item.zone }})"
      environment:
        GOOGLE_APPLICATION_CREDENTIALS: "{{ adc_file }}"
        GOOGLE_EXTERNAL_ACCOUNT_ALLOW_EXECUTABLES: "1"


    # â”€â”€ Delete firewall rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Delete Kubernetes firewall rules
      google.cloud.gcp_compute_firewall:
        name: "{{ item.name }}"
        project: "{{ gcp_project_id }}"
        auth_kind: application
        state: absent
      loop: "{{ k8s_firewall_rules }}"
      loop_control:
        label: "{{ item.name }}"
      environment:
        GOOGLE_APPLICATION_CREDENTIALS: "{{ adc_file }}"
        GOOGLE_EXTERNAL_ACCOUNT_ALLOW_EXECUTABLES: "1"

    # â”€â”€ Clean up local generated files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: Clean up generated inventory and node info files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - ../../inventory/inventory.ini
        - ../../inventory/kubespray-hosts.yaml
        - ../../inventory/node_info.json

    - name: Teardown complete
      debug:
        msg: "ğŸ—‘ï¸  All GCP resources for '{{ cluster_name }}' destroyed."